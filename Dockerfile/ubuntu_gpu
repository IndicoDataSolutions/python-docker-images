FROM gcr.io/new-indico/ubuntu

LABEL author="Chris Lee"
LABEL email="chris@indico.io"

ENV PATH=/usr/local/nvidia/bin:/usr/local/cuda/bin:${PATH} LD_LIBRARY_PATH=/usr/local/lib:/usr/local/cuda/lib64:/usr/local/nvidia/lib:/usr/local/nvidia/lib64 TERM=xterm NVIDIA_VISIBLE_DEVICES=all NVIDIA_DRIVER_CAPABILITIES=compute,utility  NVIDIA_REQUIRE_CUDA="cuda>=10.0"

WORKDIR /

RUN wget --quiet https://developer.nvidia.com/compute/cuda/10.1/Prod/local_installers/cuda_10.1.105_418.39_linux.run -O cuda-ubuntu.run
RUN wget --quiet https://storage.googleapis.com/indicoapi/cudnn-dev.deb -O cudnn-runtime.deb

RUN apt-get update && \
    apt-get install -y libxml2 libstdc++6 && \
    chmod +x cuda-ubuntu.run && \
    ./cuda-ubuntu.run --no-opengl-libs --silent --no-drm --toolkit && \
    rm cuda-ubuntu.run && \
    cd /usr/local/cuda && \
    rm -r nvvm/libnvvm-samples && \
    mkdir ../save/ && \
    mv include bin lib64 nvvm ../save && \
    rm -r * && \
    mv ../save/* . && \
    rmdir ../save && \
    cd /

RUN dpkg -i cudnn-runtime.deb && \
    rm cudnn-runtime.deb && \
    cd /